/*
 * app_mode_dvt_test.c
 *
 *  Created on: Dec 12, 2023
 *      Author: louie.liu
 */
#include "app_mode_dvt_test.h"
#include "app_config.h"

typedef struct {
	uint8_t Opcode;
	uint8_t PayloadLen;
	uint8_t Payload[20];
} testCmd_Req_t;

static Cmd_Req_t test_cmd_gen(testCmd_Req_t testCmd) {
	Cmd_Req_t cmd;
	cmd.Opcode = testCmd.Opcode;
	cmd.Payload = testCmd.Payload;
	cmd.PayloadLen = testCmd.PayloadLen;
	return cmd;
}

const testCmd_Req_t dvtCmds[] = {
		{
				OP_TURN_ON_HV_SUPPLY,
				0,
				{
						0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
						0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
				}
		},
		{
				OP_ENABLE_HV_SUPPLY,
				0,
				{
						0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
						0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
				}
		},
		{
				OP_SET_HV_SUPPLY_VOLTAGE_VALUE,
				2,
				{
						0x50, 0x2D,	//11600mV
						0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
						0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
				}
		},
		{
				OP_ENABLE_VDDS_SUPPLY,
				0,
				{
						0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
						0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
				}
		},
//		{
//				OP_ENABLE_VDDA_SUPPLY,
//				0,
//				{
//						0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
//						0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
//				}
//		},
		{
				OP_SET_DAC_AB_OUTPUT_VOLTAGE,
				4,
				{
						0xE8, 0x03, //1000mV
						0xE8, 0x03, //1000mV
						0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
						0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
				}
		},
		{
				OP_SET_STIMULUS_CIRCUIT_PARAMETERS,
				8,
				{
						0x64, 0x00, //100us
						0x01, 		//1ms
						0xE8, 0x03, //1000us
						0x00, 0x00, 0x00, 0x00, 0x00,
						0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
				}
		},
		{
				OP_SET_CURRENT_SOURCES_CONFIGURATION,
				18,
				{
						0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
						0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00,
				}
		},
		{
				OP_ENABLE_STIMULUS_CIRCUIT,
				0,
				{
						0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
						0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
				}
		},
		{
				OP_SET_SR_SEL_POSITIONS,
				3,	//Select STIM
				{
						0x00, 0x00,	//CH5~8
						0x00,		//ECG
						0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
						0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
				}
		},
		{
				OP_ENABLE_CHANNEL_MUX,
				0,
				{
						0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
						0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
				}
		},
		{
				OP_GENERATE_MOCKED_STIMULUS,
				0,
				{
						0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
						0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
				}
		},
//		{
//				OP_ENABLE_IMC,
//				0,
//				{
//						0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
//						0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
//				}
//		},
//		{
//				OP_SET_IMP_SEL_POSITIONS,
//				8,	//CH1 & CH2
//				{
//						0x00, 0x00, 0x00, 0x00,
//						0x01, 0x00, 0x00, 0x00,
//						0x00, 0x00,
//						0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
//				}
//		},
//		{
//				OP_GET_IMC_MEASURE,
//				0,
//				{
//						0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
//						0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
//				}
//		},
};
const testCmd_Req_t accCmds[] = {
		{
				OP_START_ACC,
				2,
				{
						0x64, 0x98, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
						0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
				}
		},
		{
				OP_GET_DATA_ACC,
				1,
				{
						0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
						0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
				}
		},
		{
				OP_GET_DATA_ACC,
				1,
				{
						0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
						0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
				}
		},
		{
				OP_GET_DATA_ACC,
				1,
				{
						0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
						0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
				}
		},
		{
				OP_GET_DATA_ACC,
				1,
				{
						0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
						0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
				}
		},
		{
				OP_STOP_ACC,
				1,
				{
						0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
						0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
				}
		},
};

#define TEST_CMDS		accCmds
#define TEST_INTERVAL	500

static int step = 0;
static Cmd_Req_t cmd_Simulate;
static uint32_t  ms_tick = 0U;

void app_mode_dvt_test_handler(void) {
	if (step < (sizeof(TEST_CMDS)/sizeof(testCmd_Req_t))) {
		while (HAL_GetTick() < (ms_tick + TEST_INTERVAL)) {
			HAL_Delay(1);
		}
		cmd_Simulate = test_cmd_gen(TEST_CMDS[step]);
		step++;

		sp_uart.rx.data[0] = cmd_Simulate.Opcode;
		sp_uart.rx.data[1] = cmd_Simulate.PayloadLen;
		if (cmd_Simulate.PayloadLen > 0 && cmd_Simulate.Payload != NULL) {
			for(uint8_t i=0;i<cmd_Simulate.PayloadLen;i++) {
				sp_uart.rx.data[LEN_REQ_HEADER + i] = cmd_Simulate.Payload[i];
			}
		}
		uint16_t cal_crc16 = HAL_CRC_Calculate(&hcrc, (uint32_t*)sp_uart.rx.data, LEN_REQ_HEADER + cmd_Simulate.PayloadLen);
		memcpy(&sp_uart.rx.data[LEN_REQ_HEADER + cmd_Simulate.PayloadLen], (uint8_t*)&cal_crc16, LEN_CRC);
		sp_uart.rx.len = LEN_REQ_HEADER + cmd_Simulate.PayloadLen + LEN_CRC;
		while(HANDLE_DEBUG_UART.gState != HAL_UART_STATE_READY);
		HAL_UART_Transmit(&HANDLE_DEBUG_UART, (uint8_t*)sp_uart.rx.data, sp_uart.rx.len, 10);
		ms_tick = HAL_GetTick();
	}
}

